var express      = require('express'),
    app          = express(),
    http         = require('http'),
    path         = require('path'),
    body         = require('body-parser'),
    cfenv        = require('cfenv'),
    ibmbluemix   = require('ibmbluemix'),
    IBMData      = require('ibmdata'),
    IBMPush      = require('ibmpush'),
    ibmcloudcode = require('ibmcloudcode'),
    Client       = require('ibmiotf'),
    namespace    = require('express-namespace');
    // load local modules
    //lightserver  = require('./data/lightServer');


// IBM Bluemix app id config
var config = {
    // change to real application route assigned for your application
    applicationRoute : "cierra.mybluemix.net",
    // change to real application ID generated by Bluemix for your application
    applicationId : "295033ac-e5ad-4769-bc20-9fc1711b813f"
};

app.use(body.json());
app.use(body.urlencoded({ extended: true }));

var appEnv = cfenv.getAppEnv();

var iotConfig;
var baseConfig = appEnv.getServices('cel_cierra_iot');

if(!baseConfig || Object.keys(baseConfig).length == 0) {
    var configJSON = require('./cierra_vcap.json');
    configJSON["iotf-service"].forEach(function(entry) {
        if( entry.name == 'cel_cierra_iot' ){
            iotConfig = entry;
        }
    })
}
else{
    iotConfig = baseConfig['cel_cierra_iot'];
}

// IBM Watson IoT appclient config
var appClientConfig = {
    "org": "1555wo",
    "id": "295033ac-e5ad-4769-bc20-9fc1711b813f",
    "domain": "internetofthings.ibmcloud.com",
    "auth-method": "apikey",
    "auth-key": iotConfig.credentials.apiKey,
    "auth-token": iotConfig.credentials.apiToken
};

// IBM Watson IoT device config
var deviceConfig = {
    "org": "1555wo",
    "id": "homePi",
    "domain": "internetofthings.ibmcloud.com",
    "type": "pi_cierra",
    "auth-method": "token",
    "auth-token": "2kGUBlhBx_g8Z6R-_@"
};

// init core sdk
ibmbluemix.initialize(config);
var logger = ibmbluemix.getLogger();

console.log('IOTF is set!');

// all environments 
app.set('host', process.env.VCAP_APP_HOST || 'localhost'); 
app.set('port', process.env.VCAP_APP_PORT || 3000);
app.set('views', __dirname + '/views');
app.set('view engine', 'ejs');
app.use(express.static(path.join(__dirname, 'public')));

// init service sdks 
app.use(function(req, res, next) {
    req.data = IBMData.initializeService(req);
    req.push = IBMPush.initializeService(req);
    next();
});

// init basics for an express app
app.use(require('./lib/setup'));

var ibmconfig = ibmbluemix.getConfig();
// "Require" modules and files containing endpoints and apply the routes to our application
app.use(ibmconfig.getContextRoot(), require('./lib/staticfile'));

logger.info('mbaas context root: '+ibmconfig.getContextRoot());

// initialize Watson iot connector for device
var deviceClient = new Client.IotfDevice(deviceConfig);
// initialize Watson iot connector for app
var appClient = new Client.IotfApplication(appClientConfig);

appClient.log.setLevel = 'info';
deviceClient.log.setLevel = 'info';

// now, connect device & app to IBM IOT platform
deviceClient.connect();
appClient.connect();

// --- App ---
            appClient.on('connect', function(){
                console.log("app connect event triggered!");
                // subscribe to device events
                appClient.subscribeToDeviceEvents("pi_cierra");
                // subscribe to device status
                appClient.subscribeToDeviceStatus("pi_cierra");
                    
            });

            // app error event
            appClient.on('error', function(err){
                console.log("App Error: " + err);
            });

            // --- Device ---
            deviceClient.on('connect', function(){
                console.log('Device connected!');
            });

            // device error event
            deviceClient.on('error', function(err){
                console.log('Device Error: ' + err);
            });

        // device recipient command event from app 
        deviceClient.on("command", function (commandName,format,payload,topic) {
           console.log("device command:" + commandName + "," + format + "," + payload + "," + topic);
        });


var successComm = function(){
    return function(req, res){
        var response = req.body.L;
        console.log(response);
        res.send("request received & processed");

        //demo data to send
        var myData = { 'name': 'somnath', 'role':  'architect' };
        appClient.publishDeviceCommand("pi_cierra", "homePi", "status", "json", myData);
    };
};

// var deviceId = 'homePi';

////// ExpressJS routing
//app.post('/lights', lightserver.sendLightData(appClient, deviceId));
app.post('/lights', successComm());

app.listen(ibmconfig.getPort());

logger.info('Server started at port: '+ibmconfig.getPort());
